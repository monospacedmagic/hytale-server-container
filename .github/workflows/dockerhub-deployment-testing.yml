name: Deployment Test

on:
  push:
    branches: [main, experimental]
  pull_request:
    branches: [main]

jobs:
  test-server-boot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Start Container
        run: |
          # Build the image and start the container in detached mode
          docker build -t hytale-server-test .
          docker run -d --name hytale-test \
            -e EULA=true \
            -e MINECRAFT=TRUE \
            hytale-server-test

      - name: Wait for Server Ready Log
        run: |
          echo "Waiting for Minecraft to signal 'Done'..."

          # Timeout after 300 seconds (5 minutes)
          TIMEOUT=300
          START_TIME=$(date +%s)

          while true; do
            # Check for the specific success string in the logs
            if docker logs hytale-test 2>&1 | grep -q "Done (.*s)! For help, type \"help\""; then
              echo "✅ Success: Server is ready!"
              docker logs hytale-test | tail -n 20
              break
            fi
            
            # Check if container died
            if [ "$(docker inspect -f '{{.State.Running}}' hytale-test)" != "true" ]; then
              echo "❌ Error: Container stopped unexpectedly!"
              docker logs hytale-test
              exit 1
            fi
            
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            if [ $ELAPSED -gt $TIMEOUT ]; then
              echo "❌ Error: Timeout reached before server started."
              docker logs hytale-test
              exit 1
            fi
            
            echo "Still booting... (${ELAPSED}s / ${TIMEOUT}s)"
            sleep 5
          done

      - name: Shutdown Test
        if: always()
        run: docker rm -f hytale-test